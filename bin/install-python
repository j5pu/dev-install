#!/bin/sh

set -eu

: "${PYTHON_NAME=py}"
: "${PYTHON_PREFIX=/opt/${PYTHON_NAME}}"
: "${PYTHON_VERSION=3.10}"

version="${version:-${PYTHON_VERSION}}"

url='https://www.python.org/ftp/python'
minor="${minor:-$(curl -fsSL "${url}" | awk -F '["/]' -v v="${version}." '$2 ~ v { gsub(v, ""); print $2 }' \
  | sort -V | tail -1)}"
latest="${PYTHON_VERSION}.${minor}"

export PATH="${PYTHON_PREFIX}/bin:${PATH}"
! test -x "${PYTHON_PREFIX}/bin/${PYTHON_NAME}" || installed="$(${PYTHON_NAME} --version  | awk '{ print $2 }')"

if [ "${installed-}" != "${latest}" ]; then
  root="$(dirname "${PYTHON_PREFIX}")"
  [ "${root}" = "/" ] || {
    test -w "${root}" || {
      $(command -v sudo) chown -R "$(id -u):$(id -g)" "${root}"
      $(command -v sudo) chmod -R g+w "${root}"
    }
  }
  mkdir -p "${PYTHON_PREFIX}/lib"
  PYTHON_CFLAGS="\
-I$(brew --prefix)/include \
-L$(brew --prefix)/lib \
-Wl,-rpath,$(brew --prefix)/lib \
-I$(brew --prefix)/include \
" 
  PYTHON_CONFIGURE_OPTS="\
--enable-ipv6 \
--enable-optimizations \
--enable-option-checking=fatal \
--enable-loadable-sqlite-extensions \
--enable-shared \
--prefix=${PYTHON_PREFIX} \
--program-transform-name=s/python/${PYTHON_NAME}/g \
--program-suffix= \
--with-builtin-hashlib-hashes=md5,sha1,sha256,sha512,sha3,blake2 \
--with-dbmliborder=gdbm:ndbm \
$(if [ "$(uname -s)" = "Darwin" ]; then echo "--with-dtrace"; else echo "--enable-shared"; fi) \
--with-ensurepip \
--with-lto \
--with-openssl \
--with-system-expat \
--with-system-libmpdec \
--with-system-ffi \
--quiet"
  export PYTHON_CFLAGS PYTHON_CONFIGURE_OPTS
  
  nproc="$(nproc 2>/dev/null || true)"
  export CMAKE_BUILD_PARALLEL_LEVEL="${nproc:-$(sysctl -n hw.physicalcpu)}"
  export MAKE_OPTS="-j${CMAKE_BUILD_PARALLEL_LEVEL} --quiet"

  pyvenv="$(mktemp -d)"
  git clone --quiet "https://github.com/pyenv/pyenv.git" "${pyvenv}"

  cd "${pyvenv}/plugins/python-build"
  PREFIX="${pyvenv}" ./install.sh
  PATH="${pyvenv}/bin:${PATH}"
  python-build "${latest}" "${PYTHON_PREFIX}"

  ${PYTHON_NAME} -m ensurepip --upgrade --default-pip
fi

${PYTHON_NAME} -m pip install --quiet --upgrade pip setuptools wheel
